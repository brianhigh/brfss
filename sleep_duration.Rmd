---
title: "Sleep Duration by US State"
author: "Brian High"
date: "![CC BY-SA 4.0](cc_by-sa_4.png)"
output: 
    html_document:
        fig_width: 8.5
        fig_height: 3.5
        keep_md: yes
        smaller: yes
---

## Prevalence of healthly sleep duration

The paper:

Liu Y, Wheaton AG, Chapman DP, Cunningham TJ, Lu H, Croft JB. Prevalence of 
Healthy Sleep Duration among Adults — United States, 2014. MMWR Morb Mortal 
Wkly Rep 2016;65:137–141. DOI: http://dx.doi.org/10.15585/mmwr.mm6506a1.

Reports:

> The first state-specific estimates of the prevalence of a ≥7 hour sleep 
> duration in a 24-hour period show geographic clustering of lower prevalence 
> estimates for this duration of sleep in the southeastern United States and 
> in states along the Appalachian Mountains, which are regions with the highest 
> burdens of obesity and other chronic conditions. 

## Reproduce the choropleth

Let's try and reproduce the choropleth from the paper:

![](http://www.cdc.gov/mmwr/volumes/65/wr/figures/m6506a1f.gif)

FIGURE. Age-adjusted percentage of adults who reported ≥7 hours of sleep per 
24-hour period, by state — Behavioral Risk Factor Surveillance System, 
United States, 2014

## Install Packages and Set Options

Load the required R packages, installing as necessary.

```{r, echo=TRUE, message=FALSE}
pkgs <- c("knitr", "RMySQL", "dplyr", "epitools", 
          "choroplethrMaps", "choroplethr")
for (pkg in pkgs) {
    if (! suppressWarnings(require(pkg, character.only=TRUE)) ) {
        install.packages(pkg, repos="http://cran.fhcrc.org", dependencies=TRUE)
        if (! suppressWarnings(require(pkg, character.only=TRUE)) ) {
            stop(paste0(c("Can't load package: ", pkg, "!"), collapse = ""))
        }
    }
}
```

Set `knitr` rendering options and the default number of digits for printing.

```{r set_options, echo=TRUE, message=FALSE}
opts_chunk$set(tidy=FALSE, cache=FALSE)
options(digits=4)
```

## Connect to MySQL Database

We will connect to the `localhost` and `brfss` database using an `anonymous` 
account.

```{r message=FALSE, cache=FALSE}
library(RMySQL)

con <- dbConnect(MySQL(), 
                 host="localhost", 
                 username="anonymous", 
                 password="Ank7greph-", 
                 dbname="brfss")
```

It's generally a *bad* idea to put your connection credentials in your script,
and an even *worse* idea to publish these on Github. *Don't be like me!*

```{r}
if (file.exists("con.R")) source("con.R")
```

A lesser evil is to put them in a separate file that you keep secure and private.

Even better would be to configure your system to prompt you for the password.

## Fetch the data

We need the state (`X_STATE`), age (`X_AGE80`) and sleep (`SLEPTIM1`) variables 
for adults (`X_AGE80 >= 18`) in 2014, except those from Guam (`X_STATE = 66`)
or Puerto Rico (`X_STATE = 72`).

```{r}
sql <- "SELECT X_STATE AS StateNum, X_AGE80 AS Age, 
        COUNT(*) AS Respondents,
        COUNT(IF(SLEPTIM1 BETWEEN 7 AND 24, 1, NULL)) AS HealthySleepers 
        FROM brfss 
        WHERE IYEAR = 2014 
            AND NOT (X_STATE = 66 OR X_STATE = 72) 
            AND X_AGE80 >= 18
        GROUP BY X_STATE, X_AGE80 
        ORDER BY X_STATE, X_AGE80;"

rs <- dbGetQuery(con, sql)
dbDisconnect(con)

# Save a copy of the dataset as a backup
filename <- "sleep_data_2014.csv"
if (! file.exists(filename)) write.csv(rs, filename, row.names=F)
```

## Calculate prevalence

For now, we are just using age-specific, crude prevalence (not 
[age-adjusted](http://seer.cancer.gov/seerstat/tutorials/aarates/definition.html)).

Calculate percent prevalence by age for each state, then calculate the mean of
those prevalences by state. These means will become the value of the shading in 
the choropleth.

```{r}
rs %>% group_by(Age) %>% 
    mutate(Prevalence = 100 * (HealthySleepers/Respondents)) -> sleepers
     
sleepers %>% select(StateNum, Age, Prevalence) %>% 
    group_by(StateNum) %>% 
    summarize(value=mean(Prevalence)) -> sleep.state
```

## Get state data

Get the list of states and their numbers from the 
[codebook](http://www.cdc.gov/brfss/annual_data/2014/pdf/codebook14_llcp.pdf).

We will do this in Bash. 

- Todo: Do this in R, instead of bash, for portability.

```{r, engine='bash', eval=FALSE}
curl -o codebook14_llcp_states.pdf \
    http://www.cdc.gov/brfss/annual_data/2014/pdf/codebook14_llcp.pdf
pdftk codebook14_llcp.pdf cat 2-3 output codebook14_llcp_states.pdf
pdftotext -nopgbrk -layout codebook14_llcp_states.pdf states.txt
cat states.txt | awk '{ print $1, ",", $2, $3, $4 }' | \
    sed -e 's/ , /,/g' -e 's/ [ 0-9,.]*$//g' | \
    egrep '^[0-9]+,[A-Z][a-z]+' > states_list.csv
```

## Make choropleth map

Read in the state names and their number codes from the previous step. Merge 
with the prevalence values by state number. Make the choropleth map with 
these values using the [choroplethr](https://github.com/arilamstein/choroplethr) 
package. Use five bins to match the original figure. This will reverse the order
of the levels as shown in the legend, as compared with the original map. Our
map will not show the floating square for Washington, DC, as seen in the
original map.

```{r}
states <- read.csv("states_list.csv", header=F)
names(states) <- c("StateNum", "State")
states <- mutate(states, region=tolower(State))
merge(states, sleep.state) %>% select(region, value) -> map.values
state_choropleth(map.values, num_colors = 5)
```

```{r echo=F, results='hide'}
dev.off()
```


## Age-adjustment

The shading and bins are not exactly the same as the figure in the journal
article, but they are very similar. 

We did *not* "age-adjust" in the same way that the authors described:

> The age-adjusted prevalence and 95% confidence interval (CI) of the 
> recommended healthy sleep duration (≥7 hours) was calculated by state 
> and selected characteristics, and adjusted to the 2000 projected U.S. 
> population aged ≥18 years.

We merely took the mean of the prevelance of each age level by state, 
without taking into account any other "selected characteristics" or 
the "2000 projected U.S. population".

Next, we will try age-adjustment.

## Get standard population by single age

Now, we will apply age-adjustment to the crude prevalence values. To do that,
we will need standard population totals from the US census. We will get these
via the NIH, which kindly posted them as a table on a web page.

Load the CSV data file if you have it, otherwise create the CSV by scraping the 
signle age standard populations table from the NIH website.

```{r}
agesfile <- "ages.csv"
if (file.exists(agesfile)) {
    # Read data from CSV
    ages <- read.csv(file = agesfile, header = TRUE)
} else {
    # Scrape table from NIH web page and save as CSV for later
    library(XML)
    ages.url <- "http://seer.cancer.gov/stdpopulations/stdpop.singleages.html"
    ages.tbl <- readHTMLTable(ages.url)
    ages <- ages.tbl[[1]][2:102, c(1,2)]
    row.names(ages) <- NULL
    names(ages) <- c("Age", "StdPop")
    ages$Age <- factor(as.numeric(
        sapply(ages$Age, function (x) gsub("[+]? years$", "", x))))
    ages$StdPop <- as.numeric(
        sapply(ages$StdPop, function (x) gsub(",", "", x)))
    write.csv(ages, file=agesfile, row.names=FALSE)
}
```

## Age-adjustment with `ageadjust.direct()`

We create a wrapper function around the `ageadjust.direct()` function from
the epitools package. Then we apply per state using `sapply()`.

```{r warning=FALSE}
sleepers.pop <- merge(sleepers, ages)

adjustAge <- function(state.num, data) {
    adj <- as.vector(with(data[data$StateNum==state.num,],
                        ageadjust.direct(count = HealthySleepers,
                                         pop = Respondents, 
                                         stdpop = StdPop, 
                                         conf.level = 0.95)))
    adj['StateNum'] <- state.num
    names(adj) <- c("crude.rate", "adj.rate", "lci", "uci", "StateNum")
    return(adj)
}

sleepers.adj <- sapply(unique(sleepers.pop$StateNum),
                       function(x) adjustAge(x, sleepers.pop)) %>% 
                                   t %>% as.data.frame

sleepers.adj %>% mutate(value=adj.rate*100) %>% 
    select(StateNum, value) -> sleep.state.adj
```

## Age-adjusted choropleth map

We still see differences in the bins and the colors, so we suspect that the
authors of the paper used a different method for age-adjustment. Perhaps
instead of using single age standard population numbers, they may have used
numbers for age ranges.

```{r}
merge(states, sleep.state.adj) %>% select(region, value) -> map.values
state_choropleth(map.values, num_colors = 5)
```

```{r echo=F, results='hide'}
dev.off()
```

## What's next?

- Find out why our age-adjustments don't match those in the original paper.
- [remove the state abbreviations](http://www.r-bloggers.com/how-to-remove-state-abbreviations-from-a-choroplethr-map/) from the choropleth map

## Age-adjustment with age ranges

Looking through the paper, we see this table, with a short list of five age 
ranges:

> TABLE 1. Age-specific and age-adjusted* percentage of adults who reported 
> ≥7 hours sleep per 24-hour period, by selected characteristics — Behavioral 
> Risk Factor Surveillance System, United States, 2014

```
Characteristic          No.†    % (95% CI)§
Age group (yrs)
18–24           23,234	67.8    (66.8–68.7)
25–34           42,084	62.1    (61.3–62.9)
35–44           52,385	61.7    (60.9–62.5)
45–64           173,357	62.7    (62.2–63.1)
≥65             153,246	73.7    (73.2–74.2)

Abbreviations: CI = confidence interval; NA = not applicable
* Age-adjusted to the 2000 projected U.S. population aged ≥18 years, 
  except for age groups.
† Unweighted sample of respondents. Categories might not sum to sample 
  total because of missing responses.
§ Weighted percentage and 95% CI.
```

So, we will repeat our age-adjustment using these ranges. 

```{r}
# Aggregate our ages into 5 bins
rs %>% transform(group=cut(Age, breaks=c(18,25,35,45,65,Inf), 
                        right=F, include.lowest=T)) -> rs.grp
rs.grp %>% group_by(StateNum, group) %>% 
    summarize_each(funs(sum), HealthySleepers, Respondents) -> sleepers
```


## Get standard population distribution

We will get the standard population distribution for these age ranges from the 
CDC. 

Use "Distribution #9" from the 
[age adjustment tables](http://www.cdc.gov/nchs/data/statnt/statnt20.pdf).

The tables are in a PDF, so we will have to convert to text and parse.

We will do this in Bash. 

- Todo: Do this in R, instead, for portability.

```{r engine='bash', eval=FALSE}
curl -o statnt20.pdf 'http://www.cdc.gov/nchs/data/statnt/statnt20.pdf'
pdftk statnt20.pdf cat 3 output statnt20_2.pdf
pdftotext -nopgbrk -layout statnt20_2.pdf ages.txt
iconv -c -f utf-8 -t ascii ages.txt > ages_ascii.txt
grep -A6 "Distribution #9" ages_ascii.txt | sed -r -n 's/^(.{93}).*/\1/gp' | \
    awk '{ print $1, $(NF-1), $NF }' | \
    sed -r -n -e 's/^([0-9]{2})[0-9]*/\1/g' -e 's/,//g' -e 's/ /,/gp' | \
    tail -5  > ages5.csv
```

## Import standard population distribution

```{r}
ages <- read.csv("ages5.csv", header=F, stringsAsFactors=F)
names(ages) <- c("group", "StdPop", "Weight")
ages$group <- factor(levels(sleepers$group))
```

## Apply age adjustment using `ageadjust.direct()`

We will use the function we created ealier, `adjustAge()`, which is a 
wrapper around `ageadjust.direct()`.

```{r warning=FALSE}
sleepers.pop <- merge(sleepers, ages)

sleepers.adj <- sapply(unique(sleepers.pop$StateNum),
                       function(x) adjustAge(x, sleepers.pop)) %>% 
                                   t %>% as.data.frame

sleepers.adj %>% mutate(value=adj.rate*100) %>% 
    select(StateNum, value) -> sleep.state.adj
```

## Age-adjusted choropleth map

We still see differences in the bins and the colors, even after using the
same age ranges found in tables in the original paper for ade-adjustment.

```{r}
merge(states, sleep.state.adj) %>% select(region, value) -> map.values
state_choropleth(map.values, num_colors = 5)
```

```{r echo=F, results='hide'}
dev.off()
```

